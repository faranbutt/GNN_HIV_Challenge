name: Score Submission

permissions:
  contents: write
  pull-requests: write

# Prevent multiple workflows from writing to the leaderboard simultaneously
concurrency:
  group: leaderboard-update
  cancel-in-progress: false

on:
  pull_request:
    paths:
      - 'submissions/*.csv'
  push:
    paths:
      - 'submissions/*.csv'

jobs:
  score:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.ACTION_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download Private Data (Hidden)
      env:
        PRIVATE_LABEL_URL: ${{ secrets.PRIVATE_LABEL_URL }}
        PRIVATE_TEST_IDX_URL: ${{ secrets.PRIVATE_TEST_IDX_URL }}
      run: |
        python scripts/download_private_data.py
        
    - name: Find Submission File
      id: find_submission
      run: |
        # Identify the exact CSV added in this push
        SUB=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep 'submissions/.*\.csv$' | head -n 1)
        
        # Fallback to the latest modified file if diff-tree is empty
        if [ -z "$SUB" ]; then
          SUB=$(ls -t submissions/*.csv 2>/dev/null | head -n 1)
        fi

        if [ -z "$SUB" ]; then
          echo "No submission found."
          exit 1
        fi
        
        echo "submission_file=$SUB" >> $GITHUB_OUTPUT
        echo "Found submission: $SUB"

    - name: Score Submission
      id: scoring
      run: |
        # Run scoring script and generate JSON output
        python scoring/scoring_script.py ${{ steps.find_submission.outputs.submission_file }} --json > output.txt 2>&1 || true
        
        echo "::group::Script Output"
        cat output.txt
        echo "::endgroup::"
        
        # Extract ROC-AUC score
        SCORE=$(grep -oP '"roc_auc":\s*\K[\d.]+' output.txt || echo "")
        
        if [ -z "$SCORE" ]; then
          echo "‚ùå Error: Could not extract 'roc_auc' from output."
          exit 1
        fi
        
        echo "PR_SCORE=$SCORE" >> $GITHUB_ENV
        echo "PR_SUBMISSION=${{ steps.find_submission.outputs.submission_file }}" >> $GITHUB_ENV

    - name: Update Leaderboard Files
      run: |
        # Configure git so the script can perform a pull if needed
        git config --global user.name "GNN Challenge Bot"
        git config --global user.email "bot@example.com"
        python scoring/update_leaderboard.py
      env:
        PR_USER: ${{ github.actor }}
        PR_SUBMISSION: ${{ env.PR_SUBMISSION }}
        PR_SCORE: ${{ env.PR_SCORE }}

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      env:
        SCORE: ${{ env.PR_SCORE }}
        FILE: ${{ env.PR_SUBMISSION }}
      uses: actions/github-script@v6
      with:
        script: |
          const score = process.env.SCORE;
          const file = process.env.FILE;
          const body = `## üìä Evaluation Results\n\n**Metric:** ROC-AUC\n**Score:** ${score}\n\nüìÅ File: ${file}\n\nThe leaderboard has been updated! View it [here](https://${context.repo.owner}.github.io/${context.repo.repo}/leaderboard.html).`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Commit & Push Updated Leaderboard
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        token: ${{ secrets.ACTION_TOKEN }}
        commit_message: "Update leaderboard for ${{ github.actor }} [skip ci]"
        branch: main
        file_pattern: "leaderboard.md leaderboard.csv leaderboard.html README.md"