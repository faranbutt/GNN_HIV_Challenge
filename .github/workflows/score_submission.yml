name: Score Submission

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    paths:
      - 'submissions/*.csv'
  push:
    paths:
      - 'submissions/*.csv'

jobs:
  score:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.ACTION_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure submissions folder exists
        run: |
          if [ ! -d "submissions" ]; then
            echo "‚ùå submissions/ folder missing. This repo is misconfigured."
            exit 1
          fi

      - name: Download Private Test Data (Hidden)
        env:
          PRIVATE_LABEL_URL: ${{ secrets.PRIVATE_LABEL_URL }}
          PRIVATE_TEST_IDX_URL: ${{ secrets.PRIVATE_TEST_IDX_URL }}
        run: |
          python scripts/download_private_data.py

      - name: Find Submission File (Only from this commit)
        id: find_submission
        run: |
          echo "üîç Finding submission from current commit..."

          SUB=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^submissions/.*\.csv$' | head -n 1)

          if [ -z "$SUB" ]; then
            echo "‚ùå No submission CSV found in this commit."
            exit 1
          fi

          echo "submission_file=$SUB" >> $GITHUB_OUTPUT
          echo "‚úÖ Found submission: $SUB"

      - name: Score Submission
        id: scoring
        run: |
          echo "üß™ Running scoring script..."

          python scoring/scoring_script.py ${{ steps.find_submission.outputs.submission_file }} --json > output.json

          echo "üìÑ Raw scoring output:"
          cat output.json

          python - <<EOF
import json, sys
with open("output.json") as f:
    data = json.load(f)

score = float(data.get("roc_auc", 0))

if score <= 0:
    print("‚ùå Invalid ROC-AUC score:", score)
    sys.exit(1)

print("‚úÖ ROC-AUC:", score)

with open("score.txt", "w") as f:
    f.write(str(score))
EOF

      - name: Export Score
        run: |
          SCORE=$(cat score.txt)
          echo "PR_SCORE=$SCORE" >> $GITHUB_ENV
          echo "PR_SUBMISSION=${{ steps.find_submission.outputs.submission_file }}" >> $GITHUB_ENV

      - name: Update Leaderboard
        run: |
          python scoring/update_leaderboard.py
        env:
          PR_USER: ${{ github.actor }}
          PR_SUBMISSION: ${{ env.PR_SUBMISSION }}
          PR_SCORE: ${{ env.PR_SCORE }}

      - name: Commit & Push Leaderboard
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          token: ${{ secrets.ACTION_TOKEN }}
          commit_message: "Update leaderboard [skip ci]"
          branch: main
          file_pattern: "leaderboard.csv leaderboard.md leaderboard.html"
          commit_user_name: "GNN Challenge Bot"
          commit_user_email: "bot@gnnchallenge.ai"

      - name: Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        env:
          SCORE: ${{ env.PR_SCORE }}
          FILE: ${{ env.PR_SUBMISSION }}
        with:
          script: |
            const score = process.env.SCORE;
            const file = process.env.FILE;

            const body = `## üß™ Submission Evaluated\n\n**File:** \`${file}\`\n**ROC-AUC:** **${score}**\n\nüèÜ The leaderboard has been updated.\nüëâ View: https://${context.repo.owner}.github.io/${context.repo.repo}/leaderboard.html`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
